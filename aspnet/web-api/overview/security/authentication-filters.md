---
uid: web-api/overview/security/authentication-filters
title: "ASP.NET Web API 2 kimlik doğrulaması filtrelerini | Microsoft Docs"
author: MikeWasson
description: "Bir kimlik doğrulaması filtresini bir HTTP isteğinin kimliğini doğrulayan bir bileşenidir. Web API 2 ve MVC 5 hem de kimlik doğrulaması filtreleri desteklemez, ancak bunların biraz farklı..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 09/25/2014
ms.topic: article
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 16e451f52799625983368bc938091eff47019b52
ms.sourcegitcommit: 016f4d58663bcd442930227022de23fb3abee0b3
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 02/12/2018
---
<a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="f4246-104">ASP.NET Web API 2 kimlik doğrulaması filtreleri</span><span class="sxs-lookup"><span data-stu-id="f4246-104">Authentication Filters in ASP.NET Web API 2</span></span>
====================
<span data-ttu-id="f4246-105">tarafından [CAN Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="f4246-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="f4246-106">Bir kimlik doğrulaması filtresini bir HTTP isteğinin kimliğini doğrulayan bir bileşenidir.</span><span class="sxs-lookup"><span data-stu-id="f4246-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="f4246-107">Web API 2 ve MVC 5 hem de kimlik doğrulaması filtreleri desteklemez, ancak bunların filtre arabirimi için adlandırma kuralları, çoğunlukla biraz farklı.</span><span class="sxs-lookup"><span data-stu-id="f4246-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="f4246-108">Bu konuda, Web API kimlik doğrulaması filtreleri açıklanmaktadır.</span><span class="sxs-lookup"><span data-stu-id="f4246-108">This topic describes Web API authentication filters.</span></span>


<span data-ttu-id="f4246-109">Kimlik doğrulaması filtreleri tek tek denetleyicileri veya eylemler için bir kimlik doğrulama düzeni ayarlamanıza olanak tanır.</span><span class="sxs-lookup"><span data-stu-id="f4246-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="f4246-110">Böylece, uygulamanız farklı HTTP kaynakları için farklı kimlik doğrulama mekanizmaları destekleyebilir.</span><span class="sxs-lookup"><span data-stu-id="f4246-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="f4246-111">Bu makalede, ı koddan göstereceğiz [temel kimlik doğrulaması](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) üzerinde örnek [http://aspnet.codeplex.com](http://aspnet.codeplex.com). Örnek HTTP temel erişim kimlik doğrulama düzenini (RFC 2617) uygulayan bir kimlik doğrulaması filtresini gösterir.</span><span class="sxs-lookup"><span data-stu-id="f4246-111">In this article, I'll show code from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample on [http://aspnet.codeplex.com](http://aspnet.codeplex.com). The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="f4246-112">Filtre adlı bir sınıfta uygulanır `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="f4246-112">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="f4246-113">I tüm örnek koddan hemen bir kimlik doğrulaması filtresini yazmak nasıl çalışılacağını bölümleri göstermeyecektir.</span><span class="sxs-lookup"><span data-stu-id="f4246-113">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="f4246-114">Bir kimlik doğrulaması filtresini ayarlama</span><span class="sxs-lookup"><span data-stu-id="f4246-114">Setting an Authentication Filter</span></span>

<span data-ttu-id="f4246-115">Diğer filtreleri gibi kimlik doğrulaması filtreleri uygulanan denetleyicisi başına, eylem başına veya genel olarak tüm Web API denetleyicilerinin olabilir.</span><span class="sxs-lookup"><span data-stu-id="f4246-115">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="f4246-116">Bir denetleyici için bir kimlik doğrulaması filtresini uygulamak için filtre özniteliği denetleyicisi sınıfıyla tasarlamanız.</span><span class="sxs-lookup"><span data-stu-id="f4246-116">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="f4246-117">Aşağıdaki kod kümeleri `[IdentityBasicAuthentication]` tüm denetleyicinin eylemleri için temel kimlik doğrulamasına olanak tanıyan bir denetleyici sınıfını filtre.</span><span class="sxs-lookup"><span data-stu-id="f4246-117">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="f4246-118">Bir eylem filtresi uygulamak için eylem filtreyle olarak tasarlamanız.</span><span class="sxs-lookup"><span data-stu-id="f4246-118">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="f4246-119">Aşağıdaki kod kümeleri `[IdentityBasicAuthentication]` denetleyicinin filtresini `Post` yöntemi.</span><span class="sxs-lookup"><span data-stu-id="f4246-119">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="f4246-120">Tüm Web API denetleyicilerinin filtre uygulamak için eklemeniz **GlobalConfiguration.Filters**.</span><span class="sxs-lookup"><span data-stu-id="f4246-120">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="f4246-121">Bir Web API kimlik doğrulama filtre uygulama</span><span class="sxs-lookup"><span data-stu-id="f4246-121">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="f4246-122">Web API'de kimlik doğrulama filtreler uygulamasına [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) arabirimi.</span><span class="sxs-lookup"><span data-stu-id="f4246-122">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="f4246-123">Bunlar ayrıca devralınmalıdır **System.Attribute'un**öznitelikleri olarak uygulanması için.</span><span class="sxs-lookup"><span data-stu-id="f4246-123">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="f4246-124">**IAuthenticationFilter** arabirimi iki yöntem vardır:</span><span class="sxs-lookup"><span data-stu-id="f4246-124">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="f4246-125">**AuthenticateAsync** isteğin istek kimlik bilgilerini doğrulayarak varsa kimliğini doğrular.</span><span class="sxs-lookup"><span data-stu-id="f4246-125">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="f4246-126">**ChallengeAsync** gerekirse HTTP yanıtına bir kimlik doğrulaması sınaması ekler.</span><span class="sxs-lookup"><span data-stu-id="f4246-126">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="f4246-127">Bu yöntemler tanımlanan kimlik doğrulama akışı karşılık [RFC 2612](http://tools.ietf.org/html/rfc2616) ve [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="f4246-127">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="f4246-128">İstemci kimlik bilgileri yetkilendirme üst bilgi gönderir.</span><span class="sxs-lookup"><span data-stu-id="f4246-128">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="f4246-129">Bu, genellikle istemcinin sunucudan 401 (yetkisiz) yanıt aldıktan sonra gerçekleşir.</span><span class="sxs-lookup"><span data-stu-id="f4246-129">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="f4246-130">Ancak, bir istemci, yalnızca bir 401 edindikten sonra kimlik bilgileriyle herhangi bir istek gönderebilir.</span><span class="sxs-lookup"><span data-stu-id="f4246-130">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="f4246-131">Sunucu kimlik bilgileri kabul etmez, 401 (yetkisiz) bir yanıt döndürür.</span><span class="sxs-lookup"><span data-stu-id="f4246-131">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="f4246-132">Yanıt, bir veya daha fazla zorluklar içeren bir Www-Authenticate üstbilgisi içeriyor.</span><span class="sxs-lookup"><span data-stu-id="f4246-132">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="f4246-133">Her sınama sunucu tarafından tanınan bir kimlik doğrulama düzeni belirtir.</span><span class="sxs-lookup"><span data-stu-id="f4246-133">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="f4246-134">Sunucu anonim bir istekten 401 geri dönebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="f4246-134">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="f4246-135">Aslında, genellikle kimlik doğrulama işlemini nasıl başlatılan olmasıdır:</span><span class="sxs-lookup"><span data-stu-id="f4246-135">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="f4246-136">İstemci bir anonim istek gönderir.</span><span class="sxs-lookup"><span data-stu-id="f4246-136">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="f4246-137">Sunucu 401 döndürür.</span><span class="sxs-lookup"><span data-stu-id="f4246-137">The server returns 401.</span></span>
3. <span data-ttu-id="f4246-138">İstemcileri kimlik bilgilerine sahip istek düzenini yeniden gönderir.</span><span class="sxs-lookup"><span data-stu-id="f4246-138">The clients resends the request with credentials.</span></span>

<span data-ttu-id="f4246-139">Bu akış her ikisini de içeren *kimlik doğrulaması* ve *yetkilendirme* adımları.</span><span class="sxs-lookup"><span data-stu-id="f4246-139">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="f4246-140">Kimlik doğrulaması istemci kimliğini kanıtlar.</span><span class="sxs-lookup"><span data-stu-id="f4246-140">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="f4246-141">Yetkilendirme, istemci belirli bir kaynak erişip erişemeyeceğini belirler.</span><span class="sxs-lookup"><span data-stu-id="f4246-141">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="f4246-142">Web API'de kimlik doğrulama, ancak değil yetkilendirme kimlik doğrulaması filtreleri işleyin.</span><span class="sxs-lookup"><span data-stu-id="f4246-142">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="f4246-143">Yetkilendirme denetleyici eylemi içinde veya bir yetkilendirme Filtresi tarafından yapılması gerekir.</span><span class="sxs-lookup"><span data-stu-id="f4246-143">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="f4246-144">Web API 2 ardışık düzeninde akışı şöyledir:</span><span class="sxs-lookup"><span data-stu-id="f4246-144">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="f4246-145">Bir eylem çağırmadan önce Web API Bu eylem için kimlik doğrulama filtrelerin listesi oluşturur.</span><span class="sxs-lookup"><span data-stu-id="f4246-145">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="f4246-146">Bu eylem kapsam, denetleyici kapsam ve genel kapsama sahip filtreler içerir.</span><span class="sxs-lookup"><span data-stu-id="f4246-146">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="f4246-147">Web API çağrıları **AuthenticateAsync** listesinde her filtre üzerinde.</span><span class="sxs-lookup"><span data-stu-id="f4246-147">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="f4246-148">Her filtre istekte kimlik doğrulayabilir.</span><span class="sxs-lookup"><span data-stu-id="f4246-148">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="f4246-149">Herhangi bir filtre başarıyla kimlik bilgilerini doğrular, filtre oluşturur. bir **IPrincipal** ve isteği ekler.</span><span class="sxs-lookup"><span data-stu-id="f4246-149">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="f4246-150">Bir filtre da bu noktada bir hata tetikleyebilir.</span><span class="sxs-lookup"><span data-stu-id="f4246-150">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="f4246-151">Bu durumda, kalan ardışık düzenini çalışmaz.</span><span class="sxs-lookup"><span data-stu-id="f4246-151">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="f4246-152">Bir hata varsayıldığında, istek ardışık düzen rest akar.</span><span class="sxs-lookup"><span data-stu-id="f4246-152">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="f4246-153">Son olarak, her kimlik doğrulama filtrenin Web API çağrılarının **ChallengeAsync** yöntemi.</span><span class="sxs-lookup"><span data-stu-id="f4246-153">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="f4246-154">Filtreler bu yöntem bir sınama yanıtı, eklemek için gerekirse kullanın.</span><span class="sxs-lookup"><span data-stu-id="f4246-154">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="f4246-155">Genellikle (ancak her zaman), durum 401 hatası için yanıt olacaktır.</span><span class="sxs-lookup"><span data-stu-id="f4246-155">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="f4246-156">Aşağıdaki diyagramlarda iki olası durumların gösterir.</span><span class="sxs-lookup"><span data-stu-id="f4246-156">The following diagrams show two possible cases.</span></span> <span data-ttu-id="f4246-157">İlk kimlik doğrulaması filtresini başarıyla isteğin kimliğini doğrular, bir yetkilendirme filtresi isteği yetkilendirir ve denetleyici eylemini 200 (Tamam) döndürür.</span><span class="sxs-lookup"><span data-stu-id="f4246-157">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="f4246-158">İkinci örnekte, kimlik doğrulaması filtresini isteğin kimliğini doğrular, ancak yetkilendirme filtresini 401 (yetkisiz) döndürür.</span><span class="sxs-lookup"><span data-stu-id="f4246-158">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="f4246-159">Bu durumda, denetleyici eylem çağrılır.</span><span class="sxs-lookup"><span data-stu-id="f4246-159">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="f4246-160">Kimlik doğrulaması filtresini bir Www-Authenticate üstbilgisi yanıta ekler.</span><span class="sxs-lookup"><span data-stu-id="f4246-160">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="f4246-161">Diğer olası birleşimleridir&mdash;denetleyici eylemini anonim isteklere izin veriyorsa, örneğin, bir kimlik doğrulaması filtresini ancak hiçbir yetkilendirme olabilir.</span><span class="sxs-lookup"><span data-stu-id="f4246-161">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="f4246-162">AuthenticateAsync yöntemi uygulama</span><span class="sxs-lookup"><span data-stu-id="f4246-162">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="f4246-163">**AuthenticateAsync** yöntemi isteğin kimliğini dener.</span><span class="sxs-lookup"><span data-stu-id="f4246-163">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="f4246-164">Yöntem imzası şöyledir:</span><span class="sxs-lookup"><span data-stu-id="f4246-164">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="f4246-165">**AuthenticateAsync** yöntemi aşağıdakilerden birini yapmanız gerekir:</span><span class="sxs-lookup"><span data-stu-id="f4246-165">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="f4246-166">Nothing (no-op).</span><span class="sxs-lookup"><span data-stu-id="f4246-166">Nothing (no-op).</span></span>
2. <span data-ttu-id="f4246-167">Oluşturma bir **IPrincipal** ve isteği ayarlayın.</span><span class="sxs-lookup"><span data-stu-id="f4246-167">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="f4246-168">Bir hata sonucu olarak ayarlayın.</span><span class="sxs-lookup"><span data-stu-id="f4246-168">Set an error result.</span></span>

<span data-ttu-id="f4246-169">Seçeneği (1) anlamına gelir isteği filtrenin anlayan herhangi bir kimlik bilgisi yoktu.</span><span class="sxs-lookup"><span data-stu-id="f4246-169">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="f4246-170">Seçeneği (2) anlamına gelir filtre başarıyla isteğin kimliği.</span><span class="sxs-lookup"><span data-stu-id="f4246-170">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="f4246-171">Bir hata yanıtı tetikler seçeneği (3) anlamına gelir isteği, geçersiz kimlik bilgileri (yanlış parola gibi), vardı.</span><span class="sxs-lookup"><span data-stu-id="f4246-171">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="f4246-172">Uygulama için genel anahattı işte **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="f4246-172">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="f4246-173">İstekteki kimlik bilgilerini arayın.</span><span class="sxs-lookup"><span data-stu-id="f4246-173">Look for credentials in the request.</span></span>
2. <span data-ttu-id="f4246-174">Kimlik bilgisi varsa, hiçbir şey yapma ve (no-op) döndürür.</span><span class="sxs-lookup"><span data-stu-id="f4246-174">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="f4246-175">Kimlik bilgileri vardır, ancak filtresi kimlik doğrulama şeması tanımıyor, hiçbir şey yapma ve (no-op) döndürür.</span><span class="sxs-lookup"><span data-stu-id="f4246-175">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="f4246-176">Başka bir filtre ardışık düzeninde düzenini anlamak.</span><span class="sxs-lookup"><span data-stu-id="f4246-176">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="f4246-177">Filtrenin anlayan kimlik bilgileri varsa, bunları kimlik doğrulamayı deneyin.</span><span class="sxs-lookup"><span data-stu-id="f4246-177">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="f4246-178">Kimlik bilgileri yanlış olduğunda, 401 ayarlayarak döndürün `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="f4246-178">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="f4246-179">Kimlik bilgilerinin geçerli olduğundan, oluşturma bir **IPrincipal** ve `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="f4246-179">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="f4246-180">İzleme kodu gösterir **AuthenticateAsync** yönteminden [temel kimlik doğrulaması](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) örnek.</span><span class="sxs-lookup"><span data-stu-id="f4246-180">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample.</span></span> <span data-ttu-id="f4246-181">Her adım yorumları belirtin.</span><span class="sxs-lookup"><span data-stu-id="f4246-181">The comments indicate each step.</span></span> <span data-ttu-id="f4246-182">Çeşitli hata kodunu gösterir: hiçbir kimlik bilgileri, hatalı biçimlendirilmiş kimlik bilgilerini ve hatalı kullanıcı adı/parola ile bir Authorization Üstbilgisi.</span><span class="sxs-lookup"><span data-stu-id="f4246-182">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="f4246-183">Bir hata sonucu ayarlama</span><span class="sxs-lookup"><span data-stu-id="f4246-183">Setting an Error Result</span></span>

<span data-ttu-id="f4246-184">Kimlik bilgileri geçersiz olduğunda filtresi ayarlamalısınız `context.ErrorResult` için bir **Ihttpactionresult** bir hata yanıtı oluşturur.</span><span class="sxs-lookup"><span data-stu-id="f4246-184">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="f4246-185">Hakkında daha fazla bilgi için **Ihttpactionresult**, bkz: [eylem sonuçlarını Web API 2'deki](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="f4246-185">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="f4246-186">Temel kimlik doğrulaması örnek içeren bir `AuthenticationFailureResult` bu amaç için uygun sınıfı.</span><span class="sxs-lookup"><span data-stu-id="f4246-186">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="f4246-187">Implementing ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="f4246-187">Implementing ChallengeAsync</span></span>

<span data-ttu-id="f4246-188">Amacı **ChallengeAsync** yöntemi ise kimlik doğrulama sınaması yanıt olarak eklemek için gerekli.</span><span class="sxs-lookup"><span data-stu-id="f4246-188">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="f4246-189">Yöntem imzası şöyledir:</span><span class="sxs-lookup"><span data-stu-id="f4246-189">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="f4246-190">Yöntem, her kimlik doğrulaması filtresini istek kanalında çağrılır.</span><span class="sxs-lookup"><span data-stu-id="f4246-190">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="f4246-191">Anlamak önemlidir **ChallengeAsync** çağrılır *önce* oluşturulan ve büyük olasılıkla bile denetleyici eylemi çalıştırılmadan önce HTTP yanıtı.</span><span class="sxs-lookup"><span data-stu-id="f4246-191">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="f4246-192">Zaman **ChallengeAsync** olarak adlandırılır, `context.Result` içeren bir **Ihttpactionresult**, daha sonra HTTP yanıtı oluşturmak için kullanılan.</span><span class="sxs-lookup"><span data-stu-id="f4246-192">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="f4246-193">Böyle olduğunda **ChallengeAsync** olduğu olarak adlandırılan, HTTP yanıtı hakkında hiçbir şey henüz tanımadığınız.</span><span class="sxs-lookup"><span data-stu-id="f4246-193">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="f4246-194">**ChallengeAsync** replace özgün değeri yöntemi `context.Result` yeni bir **Ihttpactionresult**.</span><span class="sxs-lookup"><span data-stu-id="f4246-194">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="f4246-195">Bu **Ihttpactionresult** özgün sarmalamanız gerekir `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="f4246-195">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="f4246-196">Özgün çağrı **Ihttpactionresult** *iç sonuç*ve yeni **Ihttpactionresult** *dış sonuç*.</span><span class="sxs-lookup"><span data-stu-id="f4246-196">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="f4246-197">Dış sonuç aşağıdakileri yapmanız gerekir:</span><span class="sxs-lookup"><span data-stu-id="f4246-197">The outer result must do the following:</span></span>

1. <span data-ttu-id="f4246-198">HTTP yanıtı oluşturmak için iç sonucunu çağırır.</span><span class="sxs-lookup"><span data-stu-id="f4246-198">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="f4246-199">Yanıt inceleyin.</span><span class="sxs-lookup"><span data-stu-id="f4246-199">Examine the response.</span></span>
3. <span data-ttu-id="f4246-200">Bir kimlik doğrulaması sınaması gerekirse yanıta ekleyin.</span><span class="sxs-lookup"><span data-stu-id="f4246-200">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="f4246-201">Aşağıdaki örnek, temel kimlik doğrulaması örnekten alınır.</span><span class="sxs-lookup"><span data-stu-id="f4246-201">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="f4246-202">Bunu tanımlayan bir **Ihttpactionresult** dış sonucu.</span><span class="sxs-lookup"><span data-stu-id="f4246-202">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="f4246-203">`InnerResult` Özelliği tutan iç **Ihttpactionresult**.</span><span class="sxs-lookup"><span data-stu-id="f4246-203">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="f4246-204">`Challenge` Özelliği bir Www kimlik doğrulama üstbilgisi temsil eder.</span><span class="sxs-lookup"><span data-stu-id="f4246-204">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="f4246-205">Dikkat **ExecuteAsync** önce çağırır `InnerResult.ExecuteAsync` HTTP yanıtı oluşturmak için ve ardından gerekirse sınaması ekler.</span><span class="sxs-lookup"><span data-stu-id="f4246-205">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="f4246-206">Yanıt kodu challenge eklemeden önce denetleyin.</span><span class="sxs-lookup"><span data-stu-id="f4246-206">Check the response code before adding the challenge.</span></span> <span data-ttu-id="f4246-207">Birçok kimlik doğrulama şemasını yalnızca bir sınama Ekle yanıt, aşağıda gösterildiği gibi 401 ise.</span><span class="sxs-lookup"><span data-stu-id="f4246-207">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="f4246-208">Ancak, bazı kimlik doğrulama şemasını bir sınama başarılı yanıt olarak ekleyin.</span><span class="sxs-lookup"><span data-stu-id="f4246-208">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="f4246-209">Örneğin, [anlaş](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="f4246-209">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="f4246-210">Verilen `AddChallengeOnUnauthorizedResult` sınıfı, Gerçek kodda **ChallengeAsync** basittir.</span><span class="sxs-lookup"><span data-stu-id="f4246-210">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="f4246-211">Yalnızca sonucu oluşturun ve ona ekleyin `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="f4246-211">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="f4246-212">Not: Temel kimlik doğrulaması örnek bu mantığı biraz, bir uzantı yönteminde koyarak soyutlar.</span><span class="sxs-lookup"><span data-stu-id="f4246-212">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="f4246-213">Ana bilgisayar düzeyinde kimlik doğrulaması ile kimlik doğrulaması filtrelerini birleştirme</span><span class="sxs-lookup"><span data-stu-id="f4246-213">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="f4246-214">"Ana bilgisayar düzeyinde kimlik doğrulaması" (örneğin, IIS), ana bilgisayar tarafından gerçekleştirilen kimlik doğrulaması önce istek ulaştığında Web API çerçevedir.</span><span class="sxs-lookup"><span data-stu-id="f4246-214">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="f4246-215">Genellikle, uygulamanızın geri kalanı için ana bilgisayar düzeyinde kimlik doğrulamasını etkinleştirmek, ancak Web API denetleyicileri için devre dışı bırakmak isteyebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="f4246-215">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="f4246-216">Örneğin, ana bilgisayar düzeyinde form kimlik doğrulamasını etkinleştirmek, ancak belirteç tabanlı kimlik doğrulaması için Web API kullanma için tipik bir senaryo olur.</span><span class="sxs-lookup"><span data-stu-id="f4246-216">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="f4246-217">Web API ardışık düzeni içinde ana bilgisayar düzeyinde kimlik doğrulaması devre dışı bırakmak için çağrı `config.SuppressHostPrincipal()` yapılandırma.</span><span class="sxs-lookup"><span data-stu-id="f4246-217">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="f4246-218">Bu Web API'ı kaldırmak neden **IPrincipal** Web API ardışık düzeni girer istek.</span><span class="sxs-lookup"><span data-stu-id="f4246-218">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="f4246-219">Etkili bir şekilde bu &quot;kaydını-kimliğini doğrulayan&quot; istek.</span><span class="sxs-lookup"><span data-stu-id="f4246-219">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="f4246-220">Ek Kaynaklar</span><span class="sxs-lookup"><span data-stu-id="f4246-220">Additional Resources</span></span>

<span data-ttu-id="f4246-221">[ASP.NET Web API güvenliğini filtreler](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN dergisi)</span><span class="sxs-lookup"><span data-stu-id="f4246-221">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
